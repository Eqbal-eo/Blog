# مدونات آفاق - نظام التسجيل المحدث

## نظرة عامة

تم تطوير نظام تسجيل متطور يتطلب من المستخدمين تقديم طلب لإنشاء مدونة والحصول على موافقة من الإدارة قبل التسجيل. يضمن هذا النظام جودة المحتوى ومراجعة المؤلفين قبل السماح لهم بالكتابة على المنصة.

## المزايا الجديدة

### 1. نظام طلب إنشاء المدونة
- نموذج شامل لطلب إنشاء مدونة
- تطلب تدوينة نموذجية (500 كلمة كحد أدنى)
- معلومات شخصية ومهنية للمتقدم
- نظام حالة الطلب (معلق، مقبول، مرفوض)

### 2. لوحة تحكم الإدارة
- عرض جميع طلبات المدونات المعلقة
- معاينة تفصيلية لكل طلب
- إمكانية قبول أو رفض الطلبات مع تحديد أسباب الرفض
- إنشاء رموز دعوة تلقائياً عند الموافقة

### 3. نظام رموز الدعوة
- إنشاء رموز دعوة فريدة (8 أحرف)
- صلاحية محدودة (30 يوم)
- ربط الرمز بالبريد الإلكتروني
- تتبع استخدام الرموز

### 4. التسجيل المحدث
- يتطلب رمز دعوة صالح
- التحقق من صلاحية الرمز وعدم استخدامه
- تحديث حالة الرمز عند الاستخدام
- ربط المستخدم الجديد برمز الدعوة

### 5. نظام الإشعارات عبر البريد الإلكتروني
- إيميلات موافقة مع رمز الدعوة
- إيميلات رفض مع أسباب مفصلة
- تصميم جذاب ومتجاوب
- دعم كامل للغة العربية

## هيكل الملفات الجديدة

```
Blog/
├── controllers/
│   └── adminController.js          # محدث - إدارة طلبات المدونات
├── routes/
│   ├── adminRoutes.js              # محدث - مسارات إدارة الطلبات
│   ├── authRoutes.js               # محدث - التحقق من رموز الدعوة
│   └── blogRequestRoutes.js        # محدث - عرض رموز الدعوة
├── services/
│   └── emailService.js             # جديد - خدمة البريد الإلكتروني
├── views/
│   ├── register.ejs                # محدث - حقل رمز الدعوة
│   ├── blog-request-status.ejs     # محدث - عرض رمز الدعوة
│   └── admin/
│       ├── pending-blog-requests.ejs  # جديد - إدارة الطلبات
│       └── blog-request-preview.ejs   # جديد - معاينة الطلبات
└── .env.example                    # جديد - إعدادات البريد الإلكتروني
```

## تدفق العمل الجديد

### 1. طلب إنشاء مدونة
1. المستخدم يزور `/blog-request`
2. يملأ النموذج مع تدوينة نموذجية
3. يتم حفظ الطلب بحالة "معلق"
4. عرض رقم الطلب للمتابعة

### 2. مراجعة الطلبات (الإدارة)
1. المشرف يزور `/admin/pending-blog-requests`
2. معاينة الطلبات والتدوينات النموذجية
3. اتخاذ قرار (موافقة/رفض)
4. إرسال إيميل تلقائي للمتقدم

### 3. الموافقة على الطلب
1. إنشاء رمز دعوة فريد
2. حفظ الرمز في قاعدة البيانات
3. إرسال إيميل موافقة مع الرمز
4. تحديث حالة الطلب إلى "مقبول"

### 4. التسجيل بالرمز
1. المستخدم يزور `/register`
2. إدخال رمز الدعوة
3. التحقق من صحة وصلاحية الرمز
4. إكمال بيانات التسجيل
5. تحديث حالة الرمز إلى "مستخدم"

## إعداد البريد الإلكتروني

### إنشاء ملف .env
```bash
cp .env.example .env
```

### إعداد Gmail (مثال)
1. تفعيل المصادقة الثنائية
2. إنشاء كلمة مرور التطبيق
3. تحديث المتغيرات:
```env
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your_email@gmail.com
EMAIL_PASS=your_app_password
EMAIL_FROM="مدونات آفاق" <noreply@your-domain.com>
```

## قاعدة البيانات

### جدول طلبات المدونات (blog_requests)
```sql
CREATE TABLE blog_requests (
  id SERIAL PRIMARY KEY,
  full_name VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL,
  specialty VARCHAR(255) NOT NULL,
  experience_years INTEGER NOT NULL,
  sample_title VARCHAR(500) NOT NULL,
  sample_content TEXT NOT NULL,
  sample_category VARCHAR(100) NOT NULL,
  motivation TEXT NOT NULL,
  status VARCHAR(20) DEFAULT 'pending',
  rejection_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  reviewed_at TIMESTAMP
);
```

### جدول رموز الدعوة (invite_codes)
```sql
CREATE TABLE invite_codes (
  id SERIAL PRIMARY KEY,
  code VARCHAR(8) UNIQUE NOT NULL,
  email VARCHAR(255) NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  is_used BOOLEAN DEFAULT FALSE,
  used_at TIMESTAMP,
  used_by_user_id INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## API المحدثة

### مسارات الإدارة الجديدة
- `GET /admin/pending-blog-requests` - عرض الطلبات المعلقة
- `POST /admin/blog-requests/:id/approve` - موافقة على طلب
- `POST /admin/blog-requests/:id/reject` - رفض طلب
- `GET /admin/blog-requests/:id/preview` - معاينة طلب

### مسارات التسجيل المحدثة
- `GET /register` - صفحة التسجيل (مع حقل رمز الدعوة)
- `POST /register` - معالجة التسجيل (مع التحقق من الرمز)

### مسارات حالة الطلب المحدثة
- `GET /blog-request-status` - صفحة البحث عن الطلب
- `POST /blog-request-status` - البحث وعرض حالة الطلب (مع رمز الدعوة)

## المزايا الأمنية

1. **التحقق من رموز الدعوة**: منع التسجيل غير المصرح به
2. **انتهاء صلاحية الرموز**: رموز محدودة المدة (30 يوم)
3. **استخدام واحد للرمز**: كل رمز يُستخدم مرة واحدة فقط
4. **ربط الرمز بالبريد**: التأكد من استخدام الرمز بواسطة المستحق
5. **مراجعة المحتوى**: ضمان جودة المؤلفين قبل السماح لهم بالكتابة

## الاختبار

### اختبار النظام محلياً
1. تشغيل الخادم: `npm start`
2. زيارة `http://localhost:3000/blog-request`
3. تقديم طلب مدونة
4. تسجيل الدخول كمشرف وزيارة `/admin/pending-blog-requests`
5. موافقة على الطلب
6. التحقق من إرسال الإيميل (في حالة إعداد البريد)
7. زيارة `/blog-request-status` للتحقق من رمز الدعوة
8. استخدام الرمز في `/register`

### بيانات اختبار
```javascript
// مثال على طلب مدونة صحيح
{
  "fullName": "أحمد محمد",
  "email": "ahmed@example.com",
  "specialty": "أدب",
  "experienceYears": "3",
  "sampleTitle": "في فلسفة الكتابة الإبداعية",
  "sampleContent": "محتوى طويل أكثر من 500 كلمة...",
  "sampleCategory": "literature",
  "motivation": "أسعى لمشاركة تجربتي في الكتابة..."
}
```

## الميزات المستقبلية المقترحة

1. **إشعارات داخل المنصة**: بدلاً من الاعتماد على البريد الإلكتروني فقط
2. **نظام التقييم**: تقييم التدوينات النموذجية بنقاط
3. **فئات متخصصة**: رموز دعوة مختلفة لفئات مختلفة من المؤلفين
4. **إحصائيات مفصلة**: تقارير عن معدلات القبول والرفض
5. **تجديد رموز الدعوة**: السماح بتجديد الرموز المنتهية الصلاحية

## المساهمة

عند إضافة ميزات جديدة للنظام:
1. تحديث هذا الملف التوثيقي
2. إضافة اختبارات للميزات الجديدة
3. التأكد من توافق النظام مع المعايير الأمنية
4. توثيق أي متغيرات بيئة جديدة في `.env.example`

## الدعم

لأي استفسارات حول النظام أو مشاكل في التطبيق، يرجى:
1. مراجعة هذا التوثيق أولاً
2. التحقق من سجلات الخادم (server logs)
3. التأكد من إعداد متغيرات البيئة بشكل صحيح
4. التحقق من اتصال قاعدة البيانات
